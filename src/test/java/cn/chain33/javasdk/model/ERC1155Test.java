package cn.chain33.javasdk.model;

import java.io.IOException;

import org.junit.Assert;
import org.junit.Test;

import com.alibaba.fastjson.JSONObject;

import cn.chain33.javasdk.client.RpcClient;
import cn.chain33.javasdk.model.rpcresult.QueryTransactionResult;
import cn.chain33.javasdk.utils.ByteUtil;
import cn.chain33.javasdk.utils.EvmUtil;
import cn.chain33.javasdk.utils.HexUtil;
import cn.chain33.javasdk.utils.TransactionUtil;

/**
 * NFT发行和转让
 *
 */
public class ERC1155Test {

	// 区块链IP
	String ip = "localhost";
	// 区块链服务端口
	int port = 8801;
	RpcClient client = new RpcClient(ip, port);

	// 合约部署人对应的区块链地址和私钥
	String address = "1M8gvr1DZ1KKVjf6XW6aYR6pHGeDRspdCx";
    String privateKey = "452281167e7fa65cdd5bcb1e40565bf06a1aa3ce4fc8954848d0427a4cc27180";
    
    // 合约代码见： https://baas.33.cn/doc/detail/152
    String codes = "60806040526040518060400160405280600381526020017f2d2d3e0000000000000000000000000000000000000000000000000000000000815250600390805190602001906200005192919062000181565b506040518060400160405280600181526020017f2800000000000000000000000000000000000000000000000000000000000000815250600490805190602001906200009f92919062000181565b506040518060400160405280600181526020017f290000000000000000000000000000000000000000000000000000000000000081525060059080519060200190620000ed92919062000181565b50348015620000fb57600080fd5b50604051806020016040528060008152506200011d816200016560201b60201c565b5033600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555062000296565b80600290805190602001906200017d92919062000181565b5050565b8280546200018f9062000231565b90600052602060002090601f016020900481019282620001b35760008555620001ff565b82601f10620001ce57805160ff1916838001178555620001ff565b82800160010185558215620001ff579182015b82811115620001fe578251825591602001919060010190620001e1565b5b5090506200020e919062000212565b5090565b5b808211156200022d57600081600090555060010162000213565b5090565b600060028204905060018216806200024a57607f821691505b6020821081141562000261576200026062000267565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b61362080620002a66000396000f3fe608060405234801561001057600080fd5b50600436106100b35760003560e01c806398c8e0821161007157806398c8e082146101b0578063a22cb465146101cc578063b2bdfa7b146101e8578063d8b7c04814610206578063e985e9c514610236578063f242432a14610266576100b3565b8062fdd58e146100b857806301ffc9a7146100e85780630e89341c146101185780630f2ad370146101485780632eb2c2d6146101645780634e1273f414610180575b600080fd5b6100d260048036038101906100cd9190612459565b610282565b6040516100df9190612fcb565b60405180910390f35b61010260048036038101906100fd91906125e8565b61034b565b60405161010f9190612e0e565b60405180910390f35b610132600480360381019061012d919061267b565b61042d565b60405161013f9190612e29565b60405180910390f35b610162600480360381019061015d9190612495565b6104c1565b005b61017e600480360381019061017991906122cf565b6107aa565b005b61019a60048036038101906101959190612510565b61084b565b6040516101a79190612db5565b60405180910390f35b6101ca60048036038101906101c5919061257c565b6109fc565b005b6101e660048036038101906101e1919061241d565b610aab565b005b6101f0610c2c565b6040516101fd9190612cd8565b60405180910390f35b610220600480360381019061021b919061263a565b610c52565b60405161022d9190612e29565b60405180910390f35b610250600480360381019061024b9190612293565b610d02565b60405161025d9190612e0e565b60405180910390f35b610280600480360381019061027b919061238e565b610d96565b005b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614156102f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102ea90612e8b565b60405180910390fd5b60008083815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60007fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061041657507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b80610426575061042582610e37565b5b9050919050565b60606002805461043c90613383565b80601f016020809104026020016040519081016040528092919081815260200182805461046890613383565b80156104b55780601f1061048a576101008083540402835291602001916104b5565b820191906000526020600020905b81548152906001019060200180831161049857829003601f168201915b50505050509050919050565b6104dd3385858560405180602001604052806000815250610d96565b60006104e884610ea1565b905060006007826040516104fc9190612cc1565b9081526020016040518091039020805461051590613383565b80601f016020809104026020016040519081016040528092919081815260200182805461054190613383565b801561058e5780601f106105635761010080835404028352916020019161058e565b820191906000526020600020905b81548152906001019060200180831161057157829003601f168201915b50505050509050600061062b82600380546105a890613383565b80601f01602080910402602001604051908101604052809291908181526020018280546105d490613383565b80156106215780601f106105f657610100808354040283529160200191610621565b820191906000526020600020905b81548152906001019060200180831161060457829003601f168201915b5050505050611076565b905060006106c3826004805461064090613383565b80601f016020809104026020016040519081016040528092919081815260200182805461066c90613383565b80156106b95780601f1061068e576101008083540402835291602001916106b9565b820191906000526020600020905b81548152906001019060200180831161069c57829003601f168201915b5050505050611076565b905060006106d18287611076565b9050600061076982600580546106e690613383565b80601f016020809104026020016040519081016040528092919081815260200182805461071290613383565b801561075f5780601f106107345761010080835404028352916020019161075f565b820191906000526020600020905b81548152906001019060200180831161074257829003601f168201915b5050505050611076565b90508060078760405161077c9190612cc1565b9081526020016040518091039020908051906020019061079d929190611f8b565b5050505050505050505050565b6107b26112b6565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614806107f857506107f7856107f26112b6565b610d02565b5b610837576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161082e90612f0b565b60405180910390fd5b61084485858585856112be565b5050505050565b60608151835114610891576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161088890612f6b565b60405180910390fd5b6000835167ffffffffffffffff8111156108d4577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156109025781602001602082028036833780820191505090505b50905060005b84518110156109f15761099b85828151811061094d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015185838151811061098e577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151610282565b8282815181106109d4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018181525050806109ea906133b5565b9050610908565b508091505092915050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610a8c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a8390612ecb565b60405180910390fd5b610aa73383836040518060200160405280600081525061161e565b5050565b8173ffffffffffffffffffffffffffffffffffffffff16610aca6112b6565b73ffffffffffffffffffffffffffffffffffffffff161415610b21576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b1890612f4b565b60405180910390fd5b8060016000610b2e6112b6565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff16610bdb6112b6565b73ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3183604051610c209190612e0e565b60405180910390a35050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6060600782604051610c649190612cc1565b90815260200160405180910390208054610c7d90613383565b80601f0160208091040260200160405190810160405280929190818152602001828054610ca990613383565b8015610cf65780601f10610ccb57610100808354040283529160200191610cf6565b820191906000526020600020905b815481529060010190602001808311610cd957829003601f168201915b50505050509050919050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b610d9e6112b6565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480610de45750610de385610dde6112b6565b610d02565b5b610e23576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e1a90612eab565b60405180910390fd5b610e308585858585611888565b5050505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b60606000821415610ee9576040518060400160405280600181526020017f30000000000000000000000000000000000000000000000000000000000000008152509050611071565b600082905060005b60008214610f1b578080610f04906133b5565b915050600a82610f149190613201565b9150610ef1565b60008167ffffffffffffffff811115610f5d577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280601f01601f191660200182016040528015610f8f5781602001600182028036833780820191505090505b50905060008290505b6000861461106957600181610fad919061328c565b90506000600a8088610fbf9190613201565b610fc99190613232565b87610fd4919061328c565b6030610fe091906131ca565b905060008160f81b905080848481518110611024577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350600a886110609190613201565b97505050610f98565b819450505050505b919050565b6060600083905060008390506000815183516110929190613174565b67ffffffffffffffff8111156110d1577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280601f01601f1916602001820160405280156111035781602001600182028036833780820191505090505b50905060005b83518110156111d15783818151811061114b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602001015160f81c60f81b82828151811061118f577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806111c9906133b5565b915050611109565b5060005b82518110156112a957828181518110611217577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602001015160f81c60f81b828286516112309190613174565b81518110611267577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806112a1906133b5565b9150506111d5565b5080935050505092915050565b600033905090565b8151835114611302576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016112f990612f8b565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff161415611372576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161136990612eeb565b60405180910390fd5b600061137c6112b6565b905061138c818787878787611b0a565b60005b84518110156115895760008582815181106113d3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015190506000858381518110611418577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101519050600080600084815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050818110156114b9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114b090612f2b565b60405180910390fd5b81810360008085815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160008085815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461156e9190613174565b9250508190555050505080611582906133b5565b905061138f565b508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611600929190612dd7565b60405180910390a4611616818787878787611b12565b505050505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16141561168e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161168590612fab565b60405180910390fd5b81518351146116d2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016116c990612f8b565b60405180910390fd5b60006116dc6112b6565b90506116ed81600087878787611b0a565b60005b84518110156117f257838181518110611732577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151600080878481518110611776577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546117d89190613174565b9250508190555080806117ea906133b5565b9150506116f0565b508473ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb878760405161186a929190612dd7565b60405180910390a461188181600087878787611b12565b5050505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614156118f8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016118ef90612eeb565b60405180910390fd5b60006119026112b6565b905061192281878761191388611ce2565b61191c88611ce2565b87611b0a565b600080600086815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050838110156119b9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119b090612f2b565b60405180910390fd5b83810360008087815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508360008087815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611a6e9190613174565b925050819055508573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628888604051611aeb929190612fe6565b60405180910390a4611b01828888888888611da8565b50505050505050565b505050505050565b611b318473ffffffffffffffffffffffffffffffffffffffff16611f78565b15611cda578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b8152600401611b77959493929190612cf3565b602060405180830381600087803b158015611b9157600080fd5b505af1925050508015611bc257506040513d601f19601f82011682018060405250810190611bbf9190612611565b60015b611c5157611bce6134d8565b80611bd95750611c16565b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c0d9190612e29565b60405180910390fd5b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c4890612e4b565b60405180910390fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614611cd8576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ccf90612e6b565b60405180910390fd5b505b505050505050565b60606000600167ffffffffffffffff811115611d27577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015611d555781602001602082028036833780820191505090505b5090508281600081518110611d93577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101818152505080915050919050565b611dc78473ffffffffffffffffffffffffffffffffffffffff16611f78565b15611f70578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b8152600401611e0d959493929190612d5b565b602060405180830381600087803b158015611e2757600080fd5b505af1925050508015611e5857506040513d601f19601f82011682018060405250810190611e559190612611565b60015b611ee757611e646134d8565b80611e6f5750611eac565b806040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ea39190612e29565b60405180910390fd5b6040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ede90612e4b565b60405180910390fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614611f6e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f6590612e6b565b60405180910390fd5b505b505050505050565b600080823b905060008111915050919050565b828054611f9790613383565b90600052602060002090601f016020900481019282611fb95760008555612000565b82601f10611fd257805160ff1916838001178555612000565b82800160010185558215612000579182015b82811115611fff578251825591602001919060010190611fe4565b5b50905061200d9190612011565b5090565b5b8082111561202a576000816000905550600101612012565b5090565b600061204161203c84613040565b61300f565b9050808382526020820190508285602086028201111561206057600080fd5b60005b8581101561209057816120768882612182565b845260208401935060208301925050600181019050612063565b5050509392505050565b60006120ad6120a88461306c565b61300f565b905080838252602082019050828560208602820111156120cc57600080fd5b60005b858110156120fc57816120e2888261227e565b8452602084019350602083019250506001810190506120cf565b5050509392505050565b600061211961211484613098565b61300f565b90508281526020810184848401111561213157600080fd5b61213c848285613341565b509392505050565b6000612157612152846130c8565b61300f565b90508281526020810184848401111561216f57600080fd5b61217a848285613341565b509392505050565b6000813590506121918161358e565b92915050565b600082601f8301126121a857600080fd5b81356121b884826020860161202e565b91505092915050565b600082601f8301126121d257600080fd5b81356121e284826020860161209a565b91505092915050565b6000813590506121fa816135a5565b92915050565b60008135905061220f816135bc565b92915050565b600081519050612224816135bc565b92915050565b600082601f83011261223b57600080fd5b813561224b848260208601612106565b91505092915050565b600082601f83011261226557600080fd5b8135612275848260208601612144565b91505092915050565b60008135905061228d816135d3565b92915050565b600080604083850312156122a657600080fd5b60006122b485828601612182565b92505060206122c585828601612182565b9150509250929050565b600080600080600060a086880312156122e757600080fd5b60006122f588828901612182565b955050602061230688828901612182565b945050604086013567ffffffffffffffff81111561232357600080fd5b61232f888289016121c1565b935050606086013567ffffffffffffffff81111561234c57600080fd5b612358888289016121c1565b925050608086013567ffffffffffffffff81111561237557600080fd5b6123818882890161222a565b9150509295509295909350565b600080600080600060a086880312156123a657600080fd5b60006123b488828901612182565b95505060206123c588828901612182565b94505060406123d68882890161227e565b93505060606123e78882890161227e565b925050608086013567ffffffffffffffff81111561240457600080fd5b6124108882890161222a565b9150509295509295909350565b6000806040838503121561243057600080fd5b600061243e85828601612182565b925050602061244f858286016121eb565b9150509250929050565b6000806040838503121561246c57600080fd5b600061247a85828601612182565b925050602061248b8582860161227e565b9150509250929050565b600080600080608085870312156124ab57600080fd5b60006124b987828801612182565b94505060206124ca8782880161227e565b93505060406124db8782880161227e565b925050606085013567ffffffffffffffff8111156124f857600080fd5b61250487828801612254565b91505092959194509250565b6000806040838503121561252357600080fd5b600083013567ffffffffffffffff81111561253d57600080fd5b61254985828601612197565b925050602083013567ffffffffffffffff81111561256657600080fd5b612572858286016121c1565b9150509250929050565b6000806040838503121561258f57600080fd5b600083013567ffffffffffffffff8111156125a957600080fd5b6125b5858286016121c1565b925050602083013567ffffffffffffffff8111156125d257600080fd5b6125de858286016121c1565b9150509250929050565b6000602082840312156125fa57600080fd5b600061260884828501612200565b91505092915050565b60006020828403121561262357600080fd5b600061263184828501612215565b91505092915050565b60006020828403121561264c57600080fd5b600082013567ffffffffffffffff81111561266657600080fd5b61267284828501612254565b91505092915050565b60006020828403121561268d57600080fd5b600061269b8482850161227e565b91505092915050565b60006126b08383612ca3565b60208301905092915050565b6126c5816132c0565b82525050565b60006126d682613108565b6126e08185613136565b93506126eb836130f8565b8060005b8381101561271c57815161270388826126a4565b975061270e83613129565b9250506001810190506126ef565b5085935050505092915050565b612732816132d2565b82525050565b600061274382613113565b61274d8185613147565b935061275d818560208601613350565b612766816134ba565b840191505092915050565b600061277c8261311e565b6127868185613158565b9350612796818560208601613350565b61279f816134ba565b840191505092915050565b60006127b58261311e565b6127bf8185613169565b93506127cf818560208601613350565b80840191505092915050565b60006127e8603483613158565b91507f455243313135353a207472616e7366657220746f206e6f6e204552433131353560008301527f526563656976657220696d706c656d656e7465720000000000000000000000006020830152604082019050919050565b600061284e602883613158565b91507f455243313135353a204552433131353552656365697665722072656a6563746560008301527f6420746f6b656e730000000000000000000000000000000000000000000000006020830152604082019050919050565b60006128b4602b83613158565b91507f455243313135353a2062616c616e636520717565727920666f7220746865207a60008301527f65726f20616464726573730000000000000000000000000000000000000000006020830152604082019050919050565b600061291a602983613158565b91507f455243313135353a2063616c6c6572206973206e6f74206f776e6572206e6f7260008301527f20617070726f76656400000000000000000000000000000000000000000000006020830152604082019050919050565b6000612980602683613158565b91507f6f6e6c7920617574686f72697a6564206f776e65722063616e2073746f72652060008301527f66696c65732e00000000000000000000000000000000000000000000000000006020830152604082019050919050565b60006129e6602583613158565b91507f455243313135353a207472616e7366657220746f20746865207a65726f20616460008301527f64726573730000000000000000000000000000000000000000000000000000006020830152604082019050919050565b6000612a4c603283613158565b91507f455243313135353a207472616e736665722063616c6c6572206973206e6f742060008301527f6f776e6572206e6f7220617070726f76656400000000000000000000000000006020830152604082019050919050565b6000612ab2602a83613158565b91507f455243313135353a20696e73756666696369656e742062616c616e636520666f60008301527f72207472616e73666572000000000000000000000000000000000000000000006020830152604082019050919050565b6000612b18602983613158565b91507f455243313135353a2073657474696e6720617070726f76616c2073746174757360008301527f20666f722073656c6600000000000000000000000000000000000000000000006020830152604082019050919050565b6000612b7e602983613158565b91507f455243313135353a206163636f756e747320616e6420696473206c656e67746860008301527f206d69736d6174636800000000000000000000000000000000000000000000006020830152604082019050919050565b6000612be4602883613158565b91507f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060008301527f6d69736d617463680000000000000000000000000000000000000000000000006020830152604082019050919050565b6000612c4a602183613158565b91507f455243313135353a206d696e7420746f20746865207a65726f2061646472657360008301527f73000000000000000000000000000000000000000000000000000000000000006020830152604082019050919050565b612cac8161332a565b82525050565b612cbb8161332a565b82525050565b6000612ccd82846127aa565b915081905092915050565b6000602082019050612ced60008301846126bc565b92915050565b600060a082019050612d0860008301886126bc565b612d1560208301876126bc565b8181036040830152612d2781866126cb565b90508181036060830152612d3b81856126cb565b90508181036080830152612d4f8184612738565b90509695505050505050565b600060a082019050612d7060008301886126bc565b612d7d60208301876126bc565b612d8a6040830186612cb2565b612d976060830185612cb2565b8181036080830152612da98184612738565b90509695505050505050565b60006020820190508181036000830152612dcf81846126cb565b905092915050565b60006040820190508181036000830152612df181856126cb565b90508181036020830152612e0581846126cb565b90509392505050565b6000602082019050612e236000830184612729565b92915050565b60006020820190508181036000830152612e438184612771565b905092915050565b60006020820190508181036000830152612e64816127db565b9050919050565b60006020820190508181036000830152612e8481612841565b9050919050565b60006020820190508181036000830152612ea4816128a7565b9050919050565b60006020820190508181036000830152612ec48161290d565b9050919050565b60006020820190508181036000830152612ee481612973565b9050919050565b60006020820190508181036000830152612f04816129d9565b9050919050565b60006020820190508181036000830152612f2481612a3f565b9050919050565b60006020820190508181036000830152612f4481612aa5565b9050919050565b60006020820190508181036000830152612f6481612b0b565b9050919050565b60006020820190508181036000830152612f8481612b71565b9050919050565b60006020820190508181036000830152612fa481612bd7565b9050919050565b60006020820190508181036000830152612fc481612c3d565b9050919050565b6000602082019050612fe06000830184612cb2565b92915050565b6000604082019050612ffb6000830185612cb2565b6130086020830184612cb2565b9392505050565b6000604051905081810181811067ffffffffffffffff821117156130365761303561348b565b5b8060405250919050565b600067ffffffffffffffff82111561305b5761305a61348b565b5b602082029050602081019050919050565b600067ffffffffffffffff8211156130875761308661348b565b5b602082029050602081019050919050565b600067ffffffffffffffff8211156130b3576130b261348b565b5b601f19601f8301169050602081019050919050565b600067ffffffffffffffff8211156130e3576130e261348b565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b600061317f8261332a565b915061318a8361332a565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156131bf576131be6133fe565b5b828201905092915050565b60006131d582613334565b91506131e083613334565b92508260ff038211156131f6576131f56133fe565b5b828201905092915050565b600061320c8261332a565b91506132178361332a565b9250826132275761322661342d565b5b828204905092915050565b600061323d8261332a565b91506132488361332a565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0483118215151615613281576132806133fe565b5b828202905092915050565b60006132978261332a565b91506132a28361332a565b9250828210156132b5576132b46133fe565b5b828203905092915050565b60006132cb8261330a565b9050919050565b60008115159050919050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b82818337600083830152505050565b60005b8381101561336e578082015181840152602081019050613353565b8381111561337d576000848401525b50505050565b6000600282049050600182168061339b57607f821691505b602082108114156133af576133ae61345c565b5b50919050565b60006133c08261332a565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8214156133f3576133f26133fe565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b60008160e01c9050919050565b600060443d10156134e85761358b565b60046000803e6134f96000516134cb565b6308c379a0811461350a575061358b565b60405160043d036004823e80513d602482011167ffffffffffffffff821117156135365750505061358b565b808201805167ffffffffffffffff81111561355557505050505061358b565b8060208301013d85018111156135705750505050505061358b565b613579826134ba565b60208401016040528296505050505050505b90565b613597816132c0565b81146135a257600080fd5b50565b6135ae816132d2565b81146135b957600080fd5b50565b6135c5816132de565b81146135d057600080fd5b50565b6135dc8161332a565b81146135e757600080fd5b5056fea2646970667358221220bf3356d2daced3fc1c26235dea195b954324f0b16cf6d2e9b65b1cfbb1f08a1664736f6c63430008000033";
    String abi = "[{\"inputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"constructor\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"bool\",\"name\": \"approved\",\"type\": \"bool\"}],\"name\": \"ApprovalForAll\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"indexed\": false,\"internalType\": \"uint256[]\",\"name\": \"values\",\"type\": \"uint256[]\"}],\"name\": \"TransferBatch\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": true,\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"indexed\": true,\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"indexed\": false,\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"indexed\": false,\"internalType\": \"uint256\",\"name\": \"value\",\"type\": \"uint256\"}],\"name\": \"TransferSingle\",\"type\": \"event\"},{\"anonymous\": false,\"inputs\": [{\"indexed\": false,\"internalType\": \"string\",\"name\": \"value\",\"type\": \"string\"},{\"indexed\": true,\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"}],\"name\": \"URI\",\"type\": \"event\"},{\"inputs\": [],\"name\": \"_owner\",\"outputs\": [{\"internalType\": \"address\",\"name\": \"\",\"type\": \"address\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"}],\"name\": \"balanceOf\",\"outputs\": [{\"internalType\": \"uint256\",\"name\": \"\",\"type\": \"uint256\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address[]\",\"name\": \"accounts\",\"type\": \"address[]\"},{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"}],\"name\": \"balanceOfBatch\",\"outputs\": [{\"internalType\": \"uint256[]\",\"name\": \"\",\"type\": \"uint256[]\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"string\",\"name\": \"id\",\"type\": \"string\"}],\"name\": \"getNFTTrace\",\"outputs\": [{\"internalType\": \"string\",\"name\": \"\",\"type\": \"string\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"internalType\": \"uint256[]\",\"name\": \"amounts\",\"type\": \"uint256[]\"}],\"name\": \"initArtNFT\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"account\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"}],\"name\": \"isApprovedForAll\",\"outputs\": [{\"internalType\": \"bool\",\"name\": \"\",\"type\": \"bool\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256[]\",\"name\": \"ids\",\"type\": \"uint256[]\"},{\"internalType\": \"uint256[]\",\"name\": \"amounts\",\"type\": \"uint256[]\"},{\"internalType\": \"bytes\",\"name\": \"data\",\"type\": \"bytes\"}],\"name\": \"safeBatchTransferFrom\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"from\",\"type\": \"address\"},{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"internalType\": \"uint256\",\"name\": \"amount\",\"type\": \"uint256\"},{\"internalType\": \"bytes\",\"name\": \"data\",\"type\": \"bytes\"}],\"name\": \"safeTransferFrom\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"operator\",\"type\": \"address\"},{\"internalType\": \"bool\",\"name\": \"approved\",\"type\": \"bool\"}],\"name\": \"setApprovalForAll\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"bytes4\",\"name\": \"interfaceId\",\"type\": \"bytes4\"}],\"name\": \"supportsInterface\",\"outputs\": [{\"internalType\": \"bool\",\"name\": \"\",\"type\": \"bool\"}],\"stateMutability\": \"view\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"address\",\"name\": \"to\",\"type\": \"address\"},{\"internalType\": \"uint256\",\"name\": \"id\",\"type\": \"uint256\"},{\"internalType\": \"uint256\",\"name\": \"amount\",\"type\": \"uint256\"},{\"internalType\": \"string\",\"name\": \"traceInfo\",\"type\": \"string\"}],\"name\": \"transferArtNFT\",\"outputs\": [],\"stateMutability\": \"nonpayable\",\"type\": \"function\"},{\"inputs\": [{\"internalType\": \"uint256\",\"name\": \"\",\"type\": \"uint256\"}],\"name\": \"uri\",\"outputs\": [{\"internalType\": \"string\",\"name\": \"\",\"type\": \"string\"}],\"stateMutability\": \"view\",\"type\": \"function\"}]";

    @Test
    public void testEvmContract() throws Exception {

        // 部署合约
        String txEncode;
        String txhash = "";

        QueryTransactionResult txResult;
        // 部署合约
        try {
            byte[] code = ByteUtil.merge(HexUtil.fromHexString(codes), abi.getBytes());

            String evmCode = EvmUtil.getCreateEvmEncode(code, "", "evm-sdk-test", "");
            
        	// TODO:实际应用过程中，不建议在业务代码中直接调用gas费， 因为这一步可能因为合约的复杂而消耗比较长的时间，导致后续流程的阻塞
            long gas = client.queryEVMGas("evm", evmCode, address);
            System.out.println("Gas fee is:" + gas);
            txEncode = EvmUtil.createEvmContract(code, "", "evm-sdk-test", privateKey, "", gas);
            txhash = client.submitTransaction(txEncode);
            System.out.print("部署合约交易hash = " + txhash);
            Thread.sleep(5000);
            txResult = client.queryTransaction(txhash);
            Assert.assertEquals(txResult.getReceipt().getTyname(), "ExecOk");
            System.out.println("; 执行结果 = " + txResult.getReceipt().getTyname());
                        
        } catch (Exception e) {
            e.printStackTrace();
            Assert.fail();
        }
        
        // 计算合约地址
        String contractAddress = TransactionUtil.convertExectoAddr(address + txhash.substring(2));
        System.out.println("部署好的合约地址 = " + contractAddress);
        
        // 调用合约
        // 批量生成NFT的ID
        int lenght = 1000;
        int[] ids = new int[lenght];
        int[] amounts = new int[lenght];
        for (int i = 0; i < lenght; i++) {
        	ids[i] = 10000 + i;
        	amounts[i] = 1;
        }

    	byte[] initNFT = EvmUtil.encodeParameter(abi, "initArtNFT", ids, amounts);
    	
    	// TODO:实际应用过程中，不建议在代码中调用gas费， 因为这一步可能因为合约的复杂而消耗比较长的时间
        long gas = getCallGas(initNFT,"", 0, contractAddress, "");
        
        txEncode = EvmUtil.callEvmContract(initNFT,"", 0, contractAddress, privateKey, "", gas);
        txhash = client.submitTransaction(txEncode);
        System.out.print("初始发行的合约hash = " + txhash);
        
		for (int tick = 0; tick < 500; tick++){
			txResult = client.queryTransaction(txhash);
			if(txResult == null) {
				Thread.sleep(5000);
				continue;
			}
	        System.out.println("; 执行结果 = " + txResult.getReceipt().getTyname());
	        break;
		}
        
        // 第100个NFT由平台转给用户A
        String userAaddress = "1FpJG4PHJARQNpyXkF6E6f9rvBx97zDaaJ";
        int id = ids[100];
        int amount = 1;
        String traceInfo = "资产溯源信息，比如：此NFT资产由小王转赠给小李，在区块链上留证";
    	byte[] transfer = EvmUtil.encodeParameter(abi, "transferArtNFT", userAaddress, id, amount, traceInfo);

        txEncode = EvmUtil.callEvmContract(transfer,"", 0, contractAddress, privateKey, "", 3000000);
        txhash = client.submitTransaction(txEncode);
        System.out.print("转NFT合约hash = " + txhash);
        Thread.sleep(5000);
        txResult = client.queryTransaction(txhash);
        System.out.println("; 执行结果 = " + txResult.getReceipt().getTyname());
        
        
        // 第100个NFT再次同用户A转给用户B
        String userBaddress = "18wzdPMKp3m3PsLf83HoctyaBnPXeRRHQG";
        traceInfo = "此token由小李在2021年8月26日转赠给小王，在区块链上留证";
    	transfer = EvmUtil.encodeParameter(abi, "transferArtNFT", userBaddress, id, amount, traceInfo);
    	// 这一步用用户A的私钥签名
    	String privateKeyA = "2d5cd98d637033028c7ee7ca78e5dd71d8aaaada0e8b3244f18bba7b6a75ba8c";
        txEncode = EvmUtil.callEvmContract(transfer,"", 0, contractAddress, privateKeyA, "",3000000);
        txhash = client.submitTransaction(txEncode);
        System.out.print("转NFT合约hash = " + txhash);
        Thread.sleep(5000);
        txResult = client.queryTransaction(txhash);
        System.out.println("; 执行结果 = " + txResult.getReceipt().getTyname());
        
        // 查询用户A和用户B地址下的资产余额
        byte[] packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", userAaddress, id);
        JSONObject query = client.callEVMAbi(contractAddress, HexUtil.toHexString(packAbiGet));
        JSONObject output = query.getJSONObject("result");
        String rawData = output.getString("rawData");
        System.out.println("用户A" + userAaddress + " 中积分余额： " + HexUtil.hexStringToAlgorism(HexUtil.removeHexHeader(rawData)));
        
        packAbiGet = EvmUtil.encodeParameter(abi, "balanceOf", userBaddress, id);
        query = client.callEVMAbi(contractAddress, HexUtil.toHexString(packAbiGet));
        output = query.getJSONObject("result");
        rawData = output.getString("rawData");
        System.out.println("用户B" + userBaddress + " 中积分余额： " + HexUtil.hexStringToAlgorism(HexUtil.removeHexHeader(rawData)));
        
        // 根据NFT的ID查询溯源历史信息
        packAbiGet = EvmUtil.encodeParameter(abi, "getNFTTrace", String.valueOf(id));
        query = client.callEVMAbi(contractAddress, HexUtil.toHexString(packAbiGet));
        output = query.getJSONObject("result");
        rawData = output.getString("rawData");
        System.out.println("NFT" + String.valueOf(id) + "溯源信息" + HexUtil.hexStringToString(HexUtil.removeHexHeader(rawData)));
        
        
    }
    
    /**
     * 
     * @param parameter
     * @param note
     * @param amount
     * @param contractAddr
     * @param paraName
     * @return
     * @throws IOException
     */
    private long getCallGas(byte[] parameter, String note, long amount, String contractAddr, String paraName) throws IOException {
    	String callEvmEncode = EvmUtil.getCallEvmEncode(parameter,note, amount, contractAddr, paraName);
        long gas = client.queryEVMGas("evm", callEvmEncode, address);
        System.out.println("Gas fee is:" + gas);
        return gas;
    }
}
